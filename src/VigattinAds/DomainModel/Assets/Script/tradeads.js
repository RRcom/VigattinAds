/* trade category map v1.0 */
var catMap = {
    "vehicles" : {
        "id" : 1,
        "cat" : {
            "all"                           : {"id" : "all", "cat" : {}},
            "car accessories & parts"       : {"id" : 5, "cat" : {
                "audio/video devices"           : {"id" : 44, "cat" : {}},
                "body & main parts"             : {"id" : 113, "cat" : {}},
                "braking systems"               : {"id" : 45, "cat" : {}},
                "car seats & interiors"         : {"id" : 92, "cat" : {}},
                "car-care"                      : {"id" : 46, "cat" : {}},
                "decorative"                    : {"id" : 47, "cat" : {}},
                "electrical & electronics"      : {"id" : 48, "cat" : {}},
                "engine components"             : {"id" : 99, "cat" : {}},
                "filtration systems"            : {"id" : 49, "cat" : {}},
                "for security & emergency"      : {"id" : 53, "cat" : {}},
                "lights and hid"                : {"id" : 50, "cat" : {}},
                "mags and tires"                : {"id" : 51, "cat" : {}},
                "mufflers"                      : {"id" : 102, "cat" : {}},
                "oils and lubricants"           : {"id" : 52, "cat" : {}},
                "others"                        : {"id" : 55, "cat" : {}},
                "suspension & steering systems" : {"id" : 54, "cat" : {}}

            }},
            "car services"                  : {"id" : 6, "cat" : {
                "airconditioning"               : {"id" : 27, "cat" : {}},
                "auto detaling"                 : {"id" : 29, "cat" : {}},
                "car insurance"                 : {"id" : 30, "cat" : {}},
                "car loans"                     : {"id" : 28, "cat" : {}},
                "others"                        : {"id" : 96, "cat" : {}},
                "repair and under chassis"      : {"id" : 26, "cat" : {}},
                "trucking"                      : {"id" : 31, "cat" : {}}

            }},
            "cars for rent"                 : {"id" : 68, "cat" : {}},
            "cars, sedans & minivans"       : {"id" : 1, "cat" : {}},
            "coup√©s & convertibles"         : {"id" : 39, "cat" : {}},
            "heavy equipment"               : {"id" : 143, "cat" : {}},
            "heavy equipment for rent"      : {"id" : 74, "cat" : {}},
            "hybrids & evs"                 : {"id" : 40, "cat" : {}},
            "luxury & sports cars"          : {"id" : 41, "cat" : {}},
            "motorcycle parts & acc"        : {"id" : 8, "cat" : {
                "audio"                         : {"id" : 98, "cat" : {}},
                "braking systems"               : {"id" : 97, "cat" : {}},
                "fairings"                      : {"id" : 59, "cat" : {}},
                "helmets and safety gears"      : {"id" : 56, "cat" : {}},
                "mags and tires"                : {"id" : 57, "cat" : {}},
                "mufflers"                      : {"id" : 58, "cat" : {}},
                "others"                        : {"id" : 95, "cat" : {}},
                "suspension system"             : {"id" : 103, "cat" : {}}
            }},
            "motorcycles & scooters"        : {"id" : 7, "cat" : {}},
            "suvs, crossovers & pickups"    : {"id" : 2, "cat" : {}},
            "trucks and buses for rent"     : {"id" : 69, "cat" : {}},
            "trucks, trailers & buses"      : {"id" : 4, "cat" : {}},
            "vans & rvs"                    : {"id" : 3, "cat" : {}},
            "other vehicles"                : {"id" : 104, "cat" : {}}
        }
    },
    "real estate" : {
        "id" : 2,
        "cat" : {
            "all"                           : {"id" : "all", "cat" : {}},
            "apartments & condos"           : {"id" : 9, "cat" : {}},
            "beaches & resorts"             : {"id" : 11, "cat" : {}},
            "commercial & industrial"       : {"id" : 12, "cat" : {}},
            "house & lots, townhouses"      : {"id" : 10, "cat" : {}},
            "lands & farms"                 : {"id" : 13, "cat" : {}},
            "memorial lot areas"            : {"id" : 14, "cat" : {}},
            "real estate services"          : {"id" : 15, "cat" : {
                "appraisals & brokerage"        : {"id" : 36, "cat" : {}},
                "architecture"                  : {"id" : 33, "cat" : {}},
                "contracting"                   : {"id" : 32, "cat" : {}},
                "interior designs"              : {"id" : 34, "cat" : {}},
                "landscape architecture"        : {"id" : 38, "cat" : {}},
                "others"                        : {"id" : 109, "cat" : {}}
            }},
            "rooms & bedspace for rent"     : {"id" : 75, "cat" : {}}
        }
    },
    "general category": {
        "id" : 4,
        "cat" : {
            "all"                               : {"id" : "all", "cat" : {}},
            "animals & pets"                    : {"id" : 64, "cat" : {
                "accessories"                   : {"id" : 125, "cat" : {}},
                "birds"                         : {"id" : 126 , "cat" : {}},
                "cats & dogs"                   : {"id" : 127 , "cat" : {}},
                "exotic"                        : {"id" : 128 , "cat" : {}},
                "fish"                          : {"id" : 129 , "cat" : {}},
                "livestock"                     : {"id" : 130 , "cat" : {}},
                "others"                        : {"id" : 131 , "cat" : {}}
            }},
            "appliances"                        : {"id" : 24, "cat" : {}},
            "arts & crafts"                     : {"id" : 119, "cat" : {}},
            "baby stuffs"                       : {"id" : 115, "cat" : {}},
            "books & other publications"        : {"id" : 175, "cat" : {}},
            "chemicals"                         : {"id" : 100, "cat" : {}},
            "computers & related items"         : {"id" : 116, "cat" : {
                "laptops & notebooks"           : {"id" : 134, "cat" : {}},
                "monitors"                      : {"id" : 196, "cat" : {}},
                "others"                        : {"id" : 180, "cat" : {}},
                "parts & accessories"           : {"id" : 135, "cat" : {}},
                "printers and scanners"         : {"id" : 195, "cat" : {}},
                "software"                      : {"id" : 136, "cat" : {}},
                "storage"                       : {"id" : 137, "cat" : {}}
            }},
            "electronics"                       : {"id" : 21, "cat" : {
                "audio & video"                 : {"id" : 138, "cat" : {}},
                "cameras"                       : {"id" : 139, "cat" : {}},
                "e-books"                       : {"id" : 142, "cat" : {}},
                "gadgets"                       : {"id" : 140, "cat" : {}},
                "others"                        : {"id" : 176, "cat" : {}}
            }},
            "farming & gardening"               : {"id" : 120, "cat" : {}},
            "food & related items"              : {"id" : 23, "cat" : {
                "cooking equipment"             : {"id" : 143, "cat" : {}},
                "drinks & beverages"            : {"id" : 144, "cat" : {}},
                "fruits & vegetables"           : {"id" : 147, "cat" : {}},
                "others"                        : {"id" : 150, "cat" : {}},
                "seafoods & meats"              : {"id" : 145, "cat" : {}},
                "seasoning & condiments"        : {"id" : 148, "cat" : {}},
                "snacks, desserts & delicacies" : {"id" : 149, "cat" : {}}

            }},
            "footwear, clothing & acc."         : {"id" : 25, "cat" : {
                "bags & wallets"                : {"id" : 151, "cat" : {}},
                "casual & formal wear"          : {"id" : 152, "cat" : {}},
                "costumes"                      : {"id" : 153, "cat" : {}},
                "gowns & dresses"               : {"id" : 154, "cat" : {}},
                "head & hair accessories"       : {"id" : 155, "cat" : {}},
                "jewelries & watches"           : {"id" : 156, "cat" : {}},
                "others"                        : {"id" : 177, "cat" : {}},
                "pants & jeans"                 : {"id" : 157, "cat" : {}},
                "shirts & blouses"              : {"id" : 159, "cat" : {}},
                "shoes, slippers & sandals"     : {"id" : 160, "cat" : {}},
                "shorts & skirts"               : {"id" : 161, "cat" : {}},
                "socks & stockings"             : {"id" : 158, "cat" : {}},
                "sportswear"                    : {"id" : 174, "cat" : {}},
                "undergarments"                 : {"id" : 162, "cat" : {}}
            }},
            "for security & emergency"          : {"id" : 114, "cat" : {}},
            "health, wellness & beauty"         : {"id" : 63, "cat" : {
                "cosmetic products"             : {"id" : 163, "cat" : {}},
                "fitness equipment"             : {"id" : 164, "cat" : {}},
                "others"                        : {"id" : 178, "cat" : {}},
                "perfumes"                      : {"id" : 197, "cat" : {}},
                "salon items & equipment"       : {"id" : 165, "cat" : {}},
                "vitamins & food supplement"    : {"id" : 166, "cat" : {}}
            }},
            "household & industrial items"      : {"id" : 66, "cat" : {
                "cleaning materials"            : {"id" : 194, "cat" : {}},
                "furnitures & fixtures"         : {"id" : 170, "cat" : {}},
                "kitchenwares"                  : {"id" : 171, "cat" : {}},
                "machineries & equipment"       : {"id" : 172, "cat" : {}},
                "others"                        : {"id" : 179, "cat" : {}},
                "tools, generators & accessories"   : {"id" : 173, "cat" : {}}
            }},
            "medical supplies & equipment"      : {"id" : 106, "cat" : {}},
            "metals, woods glasses & stones"    : {"id" : 117, "cat" : {}},
            "musical instruments"               : {"id" : 101, "cat" : {}},
            "networking & telecommunications"   : {"id" : 183, "cat" : {}},
            "office & school supplies"          : {"id" : 107, "cat" : {}},
            "party needs"                       : {"id" : 182, "cat" : {}},
            "phones & accessories"              : {"id" : 141, "cat" : {}},
            "playthings and collectibles"       : {"id" : 108, "cat" : {}},
            "services"                          : {"id" : 67, "cat" : {
                "advertising and publishing"         : {"id" : 76, "cat" : {}},
                "animal services"                    : {"id" : 167, "cat" : {}},
                "arts & entertainment"               : {"id" : 110, "cat" : {}},
                "brokerage and investment"           : {"id" : 122, "cat" : {}},
                "clothing & textile services"        : {"id" : 86, "cat" : {}},
                "consulting"                         : {"id" : 121, "cat" : {}},
                "courier & logistics"                : {"id" : 124, "cat" : {}},
                "employment & human resources"       : {"id" : 123, "cat" : {}},
                "engineering services"               : {"id" : 79, "cat" : {}},
                "events & planning"                  : {"id" : 80, "cat" : {}},
                "food services"                      : {"id" : 168, "cat" : {}},
                "hair care"                          : {"id" : 198, "cat" : {}},
                "health & medical services"          : {"id" : 81, "cat" : {}},
                "information technology"             : {"id" : 82, "cat" : {}},
                "installation services"              : {"id" : 112, "cat" : {}},
                "landscaping services"               : {"id" : 111, "cat" : {}},
                "leisure & recreational activities"  : {"id" : 169, "cat" : {}},
                "loans & insurance"                  : {"id" : 83, "cat" : {}},
                "manufacturing & franchising"        : {"id" : 77, "cat" : {}},
                "marketing and sales"                : {"id" : 192, "cat" : {}},
                "massage services"                   : {"id" : 84, "cat" : {}},
                "memorial services"                  : {"id" : 85, "cat" : {}},
                "online business"                    : {"id" : 181, "cat" : {}},
                "other services"                     : {"id" : 105, "cat" : {}},
                "outsourcing & contracting"          : {"id" : 94, "cat" : {}},
                "rental services"                    : {"id" : 87, "cat" : {}},
                "repairs and maintenance"            : {"id" : 88, "cat" : {}},
                "souvenirs & giveaways"              : {"id" : 78, "cat" : {}},
                "tutorials, classes & workshops"     : {"id" : 89, "cat" : {}}
            }},
            "sports accessories & equipment"    : {"id" : 93, "cat" : {}},
            "travels and hotels"                : {"id" : 65, "cat" : {}},
            "other items"                       : {"id" : 91, "cat" : {}}
        }
    }
};

function jsTrim(str)
{
    return str.replace(/^\s+|\s+$/gm,'');
}

var tradeAds = new (function($) {
    var iframe;

    this.init = function() {
        var category = this.getCategory();
        iframe = $('.vigattinads-frame');
        setIframe(category);
        autoSetCatFromSearch('.browseads_container .vigattinads-frame', '.browseads_container .adsbox');
    }

    function autoSetCatFromSearch(iframeSelector, resultSelector) {
        var iframe = $(iframeSelector);
        var result = $(resultSelector);
        var url = window.location.href;
        var catArray;
        var category = '';
        var finalCat = '';
        var finalUrl = '';
        if(url.match(/results\?search/)) {
            if(result.length) {
                category = $(result[0]).attr('data-category');
                catArray = category.split('|');
                finalCat = '(Ads Listing homepage ';
                $.each(catArray, function(key, value) {
                    if(value) {
                        finalCat += value+' ';
                    }
                });
                finalCat = jsTrim(finalCat);
                finalCat += ')';
                finalUrl = 'http://www.service.vigattin.com/vigattinads/showads/trade-ads-listing?showin=vigattintrade.com&template=home-sidebar-left&limit=1&keyword='+encodeURIComponent(finalCat.toLowerCase());
                $(iframe[0]).attr('src', finalUrl);
            }
        }

    }

    function setIframe(category) {
        $(iframe).each(function(key, element){
            var iframe = $(element);
            var keyword = '';
            var showIn = iframe.attr('data-showin');
            var template = (iframe.attr('data-template')) ? iframe.attr('data-template') : '';
            var action = iframe.attr('data-action');
            var rootKeyword = iframe.attr('data-root-keyword');
            var limit = (iframe.attr('data-limit')) ? iframe.attr('data-limit') : 6;
            var fixedKeyword = iframe.attr('fixed-keyword');
            var src = iframe.attr('src');
            if(!fixedKeyword) {
                $.each(category, function(key, value) {
                    if(value) {
                        keyword += jsTrim(value)+' ';
                    }
                });
                if(rootKeyword) keyword = '('+rootKeyword+' '+jsTrim(keyword)+')';
                else keyword = '('+jsTrim(keyword)+')';
            }
            else keyword = fixedKeyword;
            if(window.location.hash.substr(1) == 'preview') {
                if(!src) {
                    if(action) iframe.attr('src', 'http://www.service.vigattin.com/vigattinads/showads/'+action+'?showin=preview');
                    else iframe.attr('src', 'http://www.service.vigattin.com/vigattinads/showads?showin=preview');
                }
                else {
                    var newSrc = iframe.attr('src').split('?');
                    iframe.attr('src', newSrc[0]+'?showin=preview');
                }
            }
            else {
                if(!src) {
                    if(action) iframe.attr('src', 'http://www.service.vigattin.com/vigattinads/showads/'+action+'?showin='+encodeURIComponent(showIn)+'&template='+encodeURIComponent(template)+'&limit='+encodeURIComponent(limit)+'&keyword='+encodeURIComponent(keyword));
                    else iframe.attr('src', 'http://www.service.vigattin.com/vigattinads/showads?showin='+encodeURIComponent(showIn)+'&template='+encodeURIComponent(template)+'&limit='+encodeURIComponent(limit)+'&keyword='+encodeURIComponent(keyword));
                }
            }
        });
    }

    this.getCategory = function() {
        var url = window.location.href;
        var category = [];
        var catObject = null;
        category.push('homepage');
        catObject = this.getFirstCat(url, catMap);
        category.push((catObject != null) ? catObject.name : '');
        if(!catObject) return category;
        catObject = this.getSecondCat(url, catObject.cat);
        category.push((catObject != null) ? catObject.name : '');
        if(!catObject) return category;
        catObject = this.getThirdCat(url, catObject.cat);
        category.push((catObject != null) ? catObject.name : '');
        return category;
    }

    this.getFirstCat = function(url, map) {
        var match = url.match(/vigattintrade.com\/results\/browse\/[0-9]+/);
        if(!match) return '';
        var cat = parseInt(match[0].split('/').pop());
        var catObject = null;
        if(cat) {
            $.each(map, function(key, value) {
                if(parseInt(value.id) == parseInt(cat)) {
                    catObject = value;
                    catObject.name = key;
                }
            });
        }
        return catObject;
    }

    this.getSecondCat = function(url, map) {
        var match = url.match(/vigattintrade.com\/results\/browse\/[0-9]+\/[0-9]+/);
        if(!match) return '';
        var cat = parseInt(match[0].split('/').pop());
        var catObject = null;
        if(cat) {
            $.each(map, function(key, value) {
                if(parseInt(value.id) == parseInt(cat)) {
                    catObject = value;
                    catObject.name = key;
                }
            });
        }
        return catObject;
    }

    this.getThirdCat = function(url, map) {
        var match = url.match(/\?service=[0-9]+/);
        if(!match) return '';
        var cat = parseInt(match[0].split('=').pop());
        var catObject = null;
        if(cat) {
            $.each(map, function(key, value) {
                if(parseInt(value.id) == parseInt(cat)) {
                    catObject = value;
                    catObject.name = key;
                }
            });
        }
        return catObject;
    }
})(jQuery);

$(document).ready(function() {
    tradeAds.init();
});
